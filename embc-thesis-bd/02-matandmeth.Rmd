---
output:
  pdf_document: default
  html_document: default
---
# Material and Methods {#matandmeth}
Based on the earlier made observation in chapter \@ref(intro), it is important to improve __early maturity__ in Swiss beef cattle. 
One possibility for improving a certain trait is to use this trait in a breeding program. 
To include a certain trait in a breeding program it is important that the trait is preciseley defined and efficiently measurable.

## Definition of Early Maturity {#defem}
In the context of this project we use the following definition of "early maturity". Animals are earlier mature if they reach the state of carcass maturity faster than others. 
Animals reach carcass maturity when their carcass does not get any markdowns due to insufficient or excessive carcass fat. 

Carcass price markdowns are dependent on the payment system of the slaughterhouse.
Since 1994 the payment system of Swiss slaughterhouses for beef cattle is based on the classification system called CHTAX [Kaufmann1995]. 

## Beef carcass classification system CHTAX {#CHTAX}
The Swiss meat industry association "Proviande" is responsible for the implementation of CHTAX in Swiss slaughterhouses. 
In slaughterhouses Proviande employees classify beef either as live or dead animals to determine their price.
The first step in the classification system CHTAX is to assign the animal to a slaughter category. 
The distinct slaughter categories differ in age at slaughter, sex and weight.
Proviande employees either calculate age at slaughter as the time between birth and slaughter or determine it based on the number of incissors (front teeth) the animal has developed.
The more incissors the physiologically older the animal. Table \@ref(tab:slaughtercategory) contains a list of carcass categories used in CHTAX.

The choice of slaughter category determines the basis price of an animal per kilogram carcass weight (CW).
The law "Schlachtgewichtsverordnung" of the the Swiss federal departement EDI defines how slaughterhouses have to determine the carcass weight [@EDI2013, S.1].

```{r slaughtercategory, echo=FALSE, results='asis'}
tbl_category <- tibble::data_frame(abbreviation=c("KV", "JB", "MT", "MA", "OB", "RG", "RV", "VK"), 
                                   "slaughter category"=c("calves", "young cattle", "young bulls", "bulls or steers", 
                                              "young steers", "young heifers", "heifers or young cows", "cows"), 
                                   description=c("<161 days old", " >161 days <11 months old, <320 kg live weight", 
                                              ">161 days old, no incissors", 
                                              ">161 days old, >0 incissors for bulls, >4 incissors for steers", 
                                              ">161 days old, <5 incissors", ">161 days old, <5 incissors", 
                                              ">161 days old, >4 incissors for heifers, <5 incissors for young cows", 
                                              ">161 days old"), "base price of carcass conformation class T in Sfr. / kg carcass (*live) weight" = c("14.2","*6.3", "8.8", "6.2", "8.8", "8.8", "7.7", "7.5"))

# convert data_frame into a hux
ht_prop_sel <- huxtable::as_hux(tbl_category)
# specify total width of table compared to textwidth
huxtable::width(ht_prop_sel) <- .8
# specify width of each column
huxtable::col_width(ht_prop_sel) <- c(.2, .3, .5)
# column content is wrapped
huxtable::wrap(ht_prop_sel) <- TRUE
# add column names
ht_prop_sel <- huxtable::add_colnames(ht_prop_sel)
# borders are added
ht_prop_sel <- huxtable::set_all_borders(ht_prop_sel, 1)
# cell content is aligned to the top
huxtable::valign(ht_prop_sel) <- "top"
# setting the caption
if (knitr::is_html_output()){
  stab_flag <- '(#tab:slaughtercategory)'
} else {
  stab_flag <- '(\\#tab:slaughtercategory)'
}
ht_prop_sel <- huxtable::set_caption(ht=ht_prop_sel, 
                                     paste(stab_flag, 'Slaughter categories in CHTAX'))
ht_prop_sel

```

The second step in the classification system CHTAX is to assign the animal within its slaughter category to a carcass conformation class and a carcass fat class.

In this step Proviande employees visually and gropingly classify the carcass into five classes of carcass fat and into five classes of carcass conformation.

Carcass fat and carcass conformation have been introduced as price formation factors in Swiss slaughterhouses, because they suppose to coincide with important price-determining characteristics of beef meat [@Kaufmann1995]. 
Carcass fat when too low has been related at the moment of its introduction to poor tenderness, juiciness and palatability, when too high with increased trimming effort for the slaughterhouse [@Kaufmann1995].
A better carcass conformation in turn has been related to a higher yield of valuable meat pieces [@Proviande2015].

The assigned carcass conformation class depends on the accentuation of certain muscles and on the profile the animals body shows (Figure with living animals from Proviande 2015?).
The meatier the carcass the higher the carcass conformation class.
The lowest carcass conformation class is called X and the highest class is called C.
A detailed description of the distinct carcass conformation classes is available at \@ref(tab:conformationclass).
In combination with the slaughter category the carcass conformation class determines the basis price of an animal per kilogram carcass or live weight.
As an example \@ref(tab:conformationclass) the basis prices per kilogram carcass and live weight for a carcass of the slaughter category young bulls (MT) are available.
The determination of carcass fat class can further change the base price per kilogramm carcass weight or live weight.
Proviande employees determine the class of carcass fat by the area and the accentuation of fat that covers the carcass (\@ref(tab:fatclass).
The least fatty carcasses belong to carcass fat class 1 and the fattiest carcasses belong to carcass fat class 5.
The optimal carcass fat class is 3.
When a carcass does not belong to class 3, the carcass gets a markdown in Swiss Francs (Sfr.) per kilogramm carcass or live weight.
As an example \@ref(tab:fatclass) the markdowns per kilogram carcass weight for a carcass of the slaughter category MT are available.

```{r fatclass, echo=FALSE}
tbl_fatclass <- tibble::data_frame("carcass fat class" = c("1", "2", "3", "4", "5"), "carcass fat coverage"=c("uncovered", "partially covered", "evenly covered", "strongly covered", "excessiveley fatty"), "description"=c("no fat coverage; grips not developed","light fat coverage; muscels partially visible; all grips slightly tangible", "average even fat coverage; muscles generally covered; all grips tangible and robust", "strong fat coverage; excessive fat deposition; grips strongly developed", "fat coverage generally excessive; bulging fat formations; all grips very strongly developed"), "markdown for MT in Sfr. / kg carcass weight" = c("-0.9","-0.3","0","-0.3","-0.7"))

# convert data_frame into a hux
ht_prop_sel <- huxtable::as_hux(tbl_fatclass)
# specify total width of table compared to textwidth
huxtable::width(ht_prop_sel) <- .8
# specify width of each column
huxtable::col_width(ht_prop_sel) <- c(.2, .3, .5)
# column content is wrapped
huxtable::wrap(ht_prop_sel) <- TRUE
# add column names
ht_prop_sel <- huxtable::add_colnames(ht_prop_sel)
# borders are added
ht_prop_sel <- huxtable::set_all_borders(ht_prop_sel, 1)
# cell content is aligned to the top
huxtable::valign(ht_prop_sel) <- "top"
# setting the caption
if (knitr::is_html_output()){
  stab_flag <- '(#tab:fatclass)'
} else {
  stab_flag <- '(\\#tab:fatclass)'
}
ht_prop_sel <- huxtable::set_caption(ht=ht_prop_sel, 
                                     paste(stab_flag, 'Carcass fat classes in CHTAX'))
ht_prop_sel
```



```{r conformationclass, echo=FALSE}
tbl_conformationclass <- tibble::data_frame("carcass conformation class" = c("C", "H", "T", "A", "X"), profile=c("very convex", "convex", "linear", "concave", "very concave"), description=c("leg: accentedly wide; back: accentedly wide and full; shoulder: accentedly pronounced","leg: wide; back: wide and full; shoulder: pronounced", "leg: well developed, quite wide; back: average large; shoulder: accentedly pronounced", "leg: moderateley developed, slim, hollow; back: moderateley developed til slim ; shoulder: flat", "leg: poorly developed, very slim, very hollow; back: slim, thin, pointy wither; shoulder: flat, hollow"), "base price for MT in Sfr. / kg carcass weight"=c("5.55","5.3","4.65","4.2","3.85"))

# convert data_frame into a hux
ht_prop_sel <- huxtable::as_hux(tbl_conformationclass)
# specify total width of table compared to textwidth
huxtable::width(ht_prop_sel) <- 1.2
# specify width of each column
huxtable::col_width(ht_prop_sel) <- c(.2, .3, .8)
# column content is wrapped
huxtable::wrap(ht_prop_sel) <- TRUE
# add column names
ht_prop_sel <- huxtable::add_colnames(ht_prop_sel)
# borders are added
ht_prop_sel <- huxtable::set_all_borders(ht_prop_sel, 1)
# cell content is aligned to the top
huxtable::valign(ht_prop_sel) <- "top"
# setting the caption
if (knitr::is_html_output()){
  stab_flag <- '(#tab:conformationclass)'
} else {
  stab_flag <- '(\\#tab:conformationclass)'
}
ht_prop_sel <- huxtable::set_caption(ht=ht_prop_sel, 
                                     paste(stab_flag, 'Carcass conformation classes in CHTAX'))
ht_prop_sel
```

In conclusion age, number of incissors, sex, carcass conformation, carcass weight and carcass fat all influence the price of a beef carcass in Switzerland.
While age in days, number of incissors, carcass conformation and carcass weight are traits that should be maximal or minimal, sex and carcass fat should be optimal in the range.

Early maturity is only dependent on age at slaughter and carcass fat tough.
For there are two traits at once that influence early maturity, early maturity is not directly measurable.


## Improvement of Early Maturity
To breed for early maturity employees from Qualitas AG have proposed four strategies.
One of them is to derive the trait early maturity from the trait carcass fat.
The derivation is based on the theoretical knowledge about growth and body composition in beef cattle.

### Estimated Breeding Value (EBV) Carcass Fat
Usually muscles grow in an earlier stadium of growth than fat tissue indicating that carcass fat is usually the limiting factor for early maturity in beef cattle.
This means that carcass fat should be highly correlated with early maturity.
Based on this knowledge of beef growth, carcass fat could be a usefull trait to derive early maturity.
Therefore "Mutterkuh Schweiz", the Swiss beef breeders association, has introduced a breeding value for carcass fat in Summer 2018.
To describe and discuss carcass fat as a trait to derive early maturity, the creation and evaluation procedure of the breeding value carcass fat will be explained here.
I will use the results from the breeding value estimation as "material" to evaluate the efficiency of the breeding program.
The explanations refering to the creation of the breeding value are based on the documentation [@Kunz2018].

A breeding value tells you about the additive genetic merit of an animal in comparison to the reference population in units of the measured trait.
The breeding value is a widespread tool to rank animals in a breeding program.
To compute the breeding values for carcass fat a best linear unbiased prediction (BLUP) model has been used.
Multivariate BLUP is a statistical model combining the given knowledge about animal pedigrees, trait heritabilities, trait variancec, trait covariances, environment factors and individual phenotypic observations.
Multivariate means that BLUP accounts for the relationship between traits. 
A Multivariariate BlUP always computes breeding values for all traits at once [@Mrode2003].
Here we use phenotypic observations of three traits:

* carcass fat class as described in \@ref(tab:fatclass) 
* conformation class as described in \@ref(tab:conformationclass)
* carcass weight [dt]

Proviande employees have recorded the phenotypical observations at slaughterhouses in Switzerland during classification CHTAX of beef carcasses. 
The phenotypic observations have then been divided into two groups based on the animals age at slaughter.
While "Bankkälber" have been less or 180 d old at slaughter, "Banktiere" have been more than 180 d but less than 700 d old at slaughter.
The two groups formed separate breeding values for carcass fat.
Animals 700 d or older at slaughter have not been included in the model.
An animals phenotypical observation is beside the genetic effects dependent on the environmental conditions the animal lives in.
In BLUP the environmental effects on a phenotypic observation are either known fixed effects or unnkown random effects.
To compute the breeding value for carcass fat, carcass conformation and carcass weight the following parameters of the animals environment have been used as fixed effects:

* Proviande carcass classifying employee for carcass fat and carcass conformation
* sex
* age and squared age at slaughter (as covariable)
* slaughterhouse

Beside the random animal effect which is the breeding value, there is only one known random effect used in the model:

* farm x year

These environmental effects have been included in BLUP and used to separate additive genetic effects from environmental effects on the phenotypic observations.

Trait correlations, heritabilities and phenotypic/genetic variances have been computed by the method estimation of variance components using the Software VCE created by Groeneveld [@Kunz2018].
The results shown as heritabilities, genetic standard deviations and genetic correlations are available at \@ref(tab:variancecomponents).

```{r variancecomponents, echo=FALSE}
tbl_variancecomponents <- tibble::data_frame(c("Bankkalb conformation class","Banktier conformation class", "Bankkalb fat class", "Banktier fat class", "Bankkalb carcass weight", "Banktier carcass weight"), c(0.5, 0.83, -0.05, -0.17, 0.52, 0.29), c(0.83, 0.56, -0.03,0.15, 0.36,0.38 ), c(-0.05, -0.03, 0.31,0.73,-0.03,0.09), c(-0.17, 0.15, 0.73, 0.36,-0.20,0.26), c( 0.52, 0.36, -0.03, -0.20, 0.22,0.63 ), c(0.29,0.38,0.09,0.26,0.63,0.3), c(0.63, 0.63, 0.35, 0.36, 0.06, 0.14))
colnames(tbl_variancecomponents) <- c("genetic correlations and heritabilities","Bankkalb conformation class","Banktier conformation class", "Bankkalb fat class", "Banktier fat class", "Bankkalb carcass weight", "Banktier carcass weight", "genetic standard deviations")


# convert data_frame into a hux
ht_prop_sel <- huxtable::as_hux(tbl_variancecomponents)
# specify total width of table compared to textwidth
huxtable::width(ht_prop_sel) <- 0.8
# specify width of each column
huxtable::col_width(ht_prop_sel) <- c(.2, .3, .8)
# column content is wrapped
huxtable::wrap(ht_prop_sel) <- TRUE
# add column names
ht_prop_sel <- huxtable::add_colnames(ht_prop_sel)
# borders are added
ht_prop_sel <- huxtable::set_all_borders(ht_prop_sel, 1)
# cell content is aligned to the top
huxtable::valign(ht_prop_sel) <- "top"
# setting the caption
if (knitr::is_html_output()){
  stab_flag <- '(#tab:variancecomponents)'
} else {
  stab_flag <- '(\\#tab:variancecomponents)'
}
ht_prop_sel <- huxtable::set_caption(ht=ht_prop_sel, 
                                     paste(stab_flag, 'variancecomponents'))
ht_prop_sel
```

Heritabilities and genetic/phenotypic variances have been used to predict the response to selection (Q) for the breeding value carcass fat, carcass conformation and carcass weight.

### Response to selection (Q)

The value of response to selection selection for a breeding value predicts the traits improvement in a population over a period of time, on which the selection occurs.
Therefore it is a useful tool to evaluate the effectiveness of the breeding value carcass fat in improving the desired trait early maturity.

#### Response to selection based on Phocas and Vonrohr.

The response to selection is highly dependent on the breeding conditions in a population.
The response to selection achieved in one generation is the product of the intensity of selection ($i$), the square root of the accuracy of the breeding value ($r$) and the genetic variance ($\sigma_{g}$).
$$Q = ir\sigma_{g}$$
The intensity of selection describes, how big the proportion of animals chosen to be parents compared to the whole population is.
For example the intensity of selection is higher when you choose two of 10 animals to be parents than if you choose 5 animals to be parents.
The accuracy of the breeding value tells, how big chances are that the best animals are chosen as parents. 
For example if you have no means to distinguish between the best parents because you do not have any information about them (no records of them or relatives) or you know that the characteristics of the parents will not be inherited to their progeny (heritability=0) it would be completeley random if you choose the best parents.
The additive genetic variance in the population limits the potential for improvement using selection.
For example if you have cows that have the additive genetic potential of daily milk yields in kg of 1, 5, 7, 20 respecteveley you have the potential to get a mean additive genetic potential in milk yield of almost 20 kg by selecting the best animals for parents. 
If you have cows with an additive genetic potential in daily milk yields of 2, 3, 5, 6 respectiveley you will reach not more than an additive genetic potential of 6 kg even if you intensity and accuracy of selection is very high.
The intensity of selection is a value usually based on the usual percentage of animals chosen as parents. In this value the assumption of normal distribution for all traits is assumed (Here formula).




Therefore we created likely scenarios simulating breeding conditions for male and female selection candidates to assess the effect of breeding conditions on response to selection for this case.

The chosen scenarios differ in the number and relationship of relatives the selection candidates have and the proportion of selected male/female animals that will be parents of the beef cattle population in a generation.
From the proportion of selected animals we have computed intensities of selection applied on the population assuming that carcass fat, carcass conformation and carcass weight are normally distributed in the examined beef cattle population.
We used the R command 
Then we assigned economical weights as additional revenue in Sfr. / unit of trait gain for the involved traits carcass fat, carcass conformation and carcass weight.
The values for the scenarios are available at ... Here I will create a table combining the assumed values for each scenarion (number of siblings, number of half siblings, proportion selected, intensity of selection, economical weights)

For each scenario we have predicted the specific traits improvement $Q_m^*$ from the aggregate genotype asymptotic response to selection using linear regression as shown in \autoref{Qm} [@Andersen1994].
All computations have been conducted using RStudio [@RStudio2016].

\begin{equation}
\label{Qm}
Q_m^*= \frac {\sum_{y=1}^{2} i_ya^T(C_y^*)_m \sqrt{a^TC_y^*a}}{\sum_{y=1}^{2}L_y}
\end{equation}

Where:

* $Q$ = response to selection [trait unit / years]

* $_m$ = trait: carcass fat, carcass conformation or carcass weight. Here it means that we only take $m$ part of the matrix $C$ which makes it a $q x q$ dimensional matrix.

* $^*$ = indicates that reduction of variance during selection has been taken into account known as "Bulmer effect", values turn to asymptotic values [@Bulmer1971].

* $_y$ = sex of the predicted selection candidate (1 = male, 2 = female)

* $i$ = intensity of selection

* $C$ = covariance matrix between true and estimated breeding value before selection of dimesion $qn x qn$ ; $n$ = number of traits, $q$ = number of levels for random effects

* $a$ = vector of economical weights [Sfr. / trait unit]

* $L$ = generation intervall [years]


We have computed the response to selection $Q^*$ of the aggregate genotype  based on the following formula derived from [@Phocas1996]:

\begin{equation}
\label{Qagr}
Q^* = \frac {\sum_{y=1}^{2} i_yr_y^*\sigma^*}{\sum_{y=1}^{2}L_y}
\end{equation}

Where:

* $r$ = accuracy of aggregate genotype

* $\sigma$ = standard deviation of aggregate genotype

We computed $r^*_y$ and $\sigma^*$ using the following formulas:

\begin{equation}
\label{rasympt}
r^*=\sqrt{\frac {a^TC_y^*a}{a^TG^*a}}
\end{equation}

and

\begin{equation}
\label{sigasympt}
\sigma^*=\sqrt{a^TG^*a}
\end{equation}

Where

* $G$ = genetic variance-covariance matrix

To get $C_y^*$ we used the formula:

\begin{equation}
\label{Casympt}
\begin{bmatrix}
C_1^* \\
C_2^*
\end{bmatrix}
=
\left( 
\begin{bmatrix}
1+1/2k_1  &  1/2k_2 \\
1/2k_1    &  1+1/2k_2
\end{bmatrix}^{-1}
\otimes I_n
\right)
\begin{bmatrix}
C_1 \\
C_2
\end{bmatrix}
\end{equation}

Where

* $k$ = factor of variance reduction

* $n$ = number of traits involved

* $I$ = identity matrix of dimension n


We computed $k$ using the formula:

\begin{equation}
\label{kvarred}
k_y=i_y(i_y-x_y)
\end{equation}


Where 

* $x$ = value of trunctation on the x-axis of the populations normal distribution [standard deviations]

We computed $x_y$ from the proportion selected using the R-command `qnorm(proportion_selected, lower.tail = FALSE)`

To get the covariance matrix between true and estimated breeding value before selection $C_y$ we used the following formula:

\begin{equation}
\label{kvarred}
C_y=A_y \otimes G-PEV_y
\end{equation}

Where

* $A$ = numerator relationship matrix of dimension q x q; q = number of levels for random effects.

* $\otimes$ = sign for kronecker product

* $PEV$ = prediction error variance




#### Response to selection based on Pimentel

In contrast to the approach of Phocas and Vonrohr, Pimentel does not assume a probable breeding scenario using records from relatives.
Pimentel's approach is based on the selection index theory developed by @Hazel1943.
The selection index theory describes how an aggregate genotype can be computed.
The term genotype is here used as synonym for breeding value.




\begin{equation}
Q_m^*= \frac { \sum_{y=1}^{2} i_ya^T(C_y^*)_m \sqrt{a^TC_y^*a}}{\sum_{y=1}^{2}L_y}
(\#eq:Qm)
\end{equation}

Watch \@ref(eq:Qm)

\begin{equation}
\label{Qm}
Q_m^*= \frac { \sum_{y=1}^{2} i_ya^T(C_y^*)_m \sqrt{a^TC_y^*a}}{\sum_{y=1}^{2}L_y}
\end{equation}

see \autoref{Qm}

@Phocas1996


```{r}
pnumb=1+2
x<-pedigree(sire=c(NA,NA,1), dam=c(NA,NA,2), label=1:pnumb)
getA(x)
```

