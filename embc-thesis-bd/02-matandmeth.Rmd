---
output:
  pdf_document: default
---
```{r, echo=FALSE}
library(knitr)
library(kableExtra)
```

# Material and Methods {#matandmeth}
Based on the earlier made observation in chapter \@ref(intro), it is important to improve __early maturity__ in Swiss beef cattle. 
One possibility for improving a certain trait is to use this trait in a breeding program. 
To include a certain trait in a breeding program it is important that the trait is preciseley defined and efficiently measurable.

## Definition of Early Maturity {#defem}
In the context of this project we use the following definition of "early maturity". Animals are earlier mature if they reach the state of carcass maturity faster than others. 
Animals reach carcass maturity when their carcass does not get any markdowns due to insufficient or excessive carcass fat. 

Carcass price markdowns are dependent on the payment system of the slaughterhouse.
Since 1994 the payment system of Swiss slaughterhouses for beef cattle is based on the classification system called CHTAX [Kaufmann1995]. 

## Beef carcass classification system CHTAX {#CHTAX}
The Swiss meat industry association "Proviande" is responsible for the implementation of CHTAX in Swiss slaughterhouses. 
In slaughterhouses Proviande employees classify beef carcasses to determine their price.
The first step in the classification system CHTAX is to assign the carcass to a slaughter category. 
The distinct carcass categories differ in age at slaughter, anatomical maturity, sex and weight.
Proviande employees determine anatomical maturity based on the number of incissors (front teeth) the animal has developed until slaughter.
The more incissors the more anatomically mature is the animal. 
Table \@ref(tab:slaughtercategory) contains the list of carcass categories and their description used in CHTAX.

Slaughterhouses have to determine the carcass weight by weighing the trimmed carcass. 
Consequently not included in the carcass weight are head, tail, guts, surface fat and lower legs [@EDI2013].

```{r slaughtercategory, echo=FALSE}
x <- data.frame(abbreviation=c("KV", "JB", "MT", "MA", "OB", "RG", "RV", "VK"), 
                                   category=c("calves", "young cattle", "young bulls", "bulls or steers", 
                                              "young steers", "young heifers", "heifers or young cows", "cows"), 
                                   description=c("<161 days old", " >161 days <11 months old, <320 kg live weight", 
                                              ">161 days old, no incissors", 
                                              ">161 days old, >0 incissors for bulls, >4 incissors for steers", 
                                              ">161 days old, <5 incissors", ">161 days old, <5 incissors", 
                                              ">161 days old, >4 incissors for heifers, <5 incissors for young cows", 
                                              ">161 days old"))

kable(x, booktabs=T, caption="Description of slaughter categories") %>%
kable_styling(full_width =T) %>%
column_spec(3, width="8cm")
```

The second step in the classification system CHTAX is to assign the carcass to a carcass conformation class (CC) and a carcass fat class (CF) within its slaughter category.
In this step Proviande employees visually classify the carcass into five classes of carcass fat and into five classes of carcass conformation.
These classifications are important factors for the determination of the price of the carcass.

Carcass fat and carcass conformation have been introduced as price formation factors in Swiss slaughterhouses, because they suppose to coincide with important price-determining characteristics of beef meat [@Kaufmann1995]. 
Carcass fat when too low has been related to poor tenderness, juiciness and palatability, when too high with increased trimming effort for the slaughterhouse [@Kaufmann1995].
A better carcass conformation in turn has been related to a higher yield of valuable meat pieces [@Proviande2015].

The assigned carcass conformation class depends on the accentuation of certain muscles the carcass shows.
The meatier the carcass the higher the carcass conformation class.
The lowest carcass conformation class is called X and the highest class is called C.
Carcass conformation class C is the most favoured class and will result in the highest price of the carcass.
A detailed description of the distinct carcass conformation classes is available at table \@ref(tab:conformationclass).
In combination with the slaughter category the carcass conformation class determines the basis price of an animal per kilogram carcass weight (CW).
Slaughterhouses have to determine the carcass weight by weighing the trimmed carcass. 
Consequently not included in the carcass weight are head, tail, guts, surface fat and lower legs [@EDI2013].

The determination of carcass fat class can further decrease the base price per kilogramm carcass weight.
When a carcass does not belong to class 3, the carcass gets a markdown in Swiss Francs (Sfr.) per kilogramm carcass weight.
Proviande employees determine the class of carcass fat by the area and the accentuation of fat that covers the carcass (see table \@ref(tab:fatclass)).
The least fatty carcasses belong to carcass fat class 1 and the fattiest carcasses belong to carcass fat class 5.

```{r fatclass, echo=FALSE}
x<-data.frame(class = c("1", "2", "3", "4", "5"), description=c("no fat coverage","light fat coverage; muscels partially visible", "average even fat coverage; muscles generally covered", "strong fat coverage; excessive fat deposition", "fat coverage generally excessive; bulging fat formations"))
kable(x, booktabs=T, caption="Description of carcass fat classes (Proviande, 2015)") %>%
kable_styling(full_width =T) %>%
column_spec(1, width="0.5cm")

```
---
nocite: | 
  @Proviande2015
...
```{r conformationclass, echo=FALSE}
x<-data.frame(class = c("C", "H", "T", "A", "X"), description=c("leg: accentedly wide; back: accentedly wide and full; shoulder: accentedly pronounced","leg: wide; back: wide and full; shoulder: pronounced", "leg: well developed, quite wide; back: average large; shoulder: accentedly pronounced", "leg: moderateley developed, slim, hollow; back: moderateley developed til slim ; shoulder: flat", "leg: poorly developed, very slim, very hollow; back: slim, thin, pointy wither; shoulder: flat, hollow"))

kable(x, booktabs=T, caption="Description of carcass conformation classes (Proviande, 2015)") %>%
kable_styling(full_width =T) %>%
column_spec(1, width="0.5cm")
```

In conclusion age, number of incissors, sex, carcass conformation, carcass weight and carcass fat all influence the price of a beef carcass in Switzerland.
While age in days, number of incissors, carcass conformation and carcass weight are traits that should be maximal or minimal, sex and carcass fat should be optimal in the range.

Early maturity is only dependent on age at slaughter and carcass fat though.
For there are two traits at once that influence early maturity, early maturity is not directly measurable.
There is no straightforward solution for breeding directed for a not directly measurable trait.


## Strategies to improve Early Maturity
To breed for early maturity employees from Qualitas AG have proposed four strategies, which I will evaluate.
One of them is to derive the trait early maturity from the trait carcass fat.

### Deriving Early Maturity from Carcass Fat

The derivation of one trait to another requires that the involved traits are closely correlated. 
Therefore carcass fat should be highly correlated with early maturity.
The assumed correlation is based on the theoretical knowledge about growth and body composition in beef cattle.
Usually muscles grow in an earlier stadium of growth than fat tissue (Figure and reference Thonney?).
This indicates that carcass fat is usually the limiting factor for early maturity in beef cattle.
Based on this knowledge of beef growth, carcass fat could be a usefull trait to derive early maturity.
Therefore "Mutterkuh Schweiz", the Swiss beef breeders association, has introduced a breeding value for carcass fat in Summer 2018.

*The characteristics of the breeding value carcass fat were the material to asses the suitability of carcass fat for deriving early maturity. 
To describe and discuss carcass fat as a trait to derive early maturity, the creation and evaluation procedure of the breeding value carcass fat will be explained here.
I will use the results from the breeding value estimation as "material" to evaluate the efficiency of the breeding program.
The explanations refering to the creation of the breeding value car are based on the documentation of @Kunz2018.*



A breeding value tells you about the additive genetic merit of an animal in comparison to the reference population in units of the measured trait.
The breeding value is a widespread tool to rank animals in a breeding program.
To compute the breeding values for carcass fat a multivariate best linear unbiased prediction (BLUP) model is used [@Kunz2018].
BLUP is a statistical model combining the given knowledge about animal pedigrees, trait heritabilities, trait variances/covariances, environment factors and individual phenotypic records.
Multivariate means that BLUP accounts for the phenotypic, genetic and residual covariances between the involved traits. 
A Multivariariate BlUP computes breeding values synchronically for all involved traits [@Mrode2003].
Phenotypic records of three carcass traits are used to estimate the breeding value for carcass fat:

* carcass fat [score] (table \@ref(tab:fatclass) 
* carcass conformation [score] (table \@ref(tab:conformationclass))
* carcass weight [dt]

Each beef carcass delivers one record per carcass trait.
Proviande employees make the records of the traits at slaughterhouses in Switzerland routeneley according to CHTAX (see table \ref(CHTAX)).

An animals record is dependent on the environmental conditions the animal lives in beside the genetic effects.
The environmental effects of the different conditions have been included in BLUP and used to separate additive genetic effects from environmental effects on the phenotypic observations.
In BLUP the environmental effects on a phenotypic observation are either known fixed effects or unnkown random effects.
To compute the breeding value for carcass fat, carcass conformation and carcass weight the following parameters of the animals environment have been used as fixed effects:

* Proviande carcass classifier for carcass fat and carcass conformation
* sex
* age and squared age at slaughter (as covariable)
* slaughterhouse

Beside the random animal effect which is the breeding value, there is only one known random effect used in the model:

* farm x year

Ultimateley the breeding values are divided into two groups based on age at slaughter of the animal which delivered the record.
While the group "calves (c)" includes animals which are less or 180 d old at slaughter, the group "stirks (s)" includes animals which are more than 180 d but less than 700 d old at slaughter.
Animals 700 d or older at slaughter are not included in the model and do not get a breeding value.

The computation of multivariate BLUP breeding values enabled the estimation of variance components in the population.
Variance components consist of phenotypical, genetic, fixed effects and residual variances/covariances.
They have been computed by the method "estimation of variance components" using the Software VCE created by Groeneveld [@Kunz2018].
The variance components divided into the two groups of breeding values "calves" (see table \@ref(tab:calvesvariancecomponents)) and "stirks" (see table \@ref(tab:stirksvariancecomponents)).

```{r calvesvariancecomponents, echo=FALSE}
library(knitr)
library(kableExtra)
g<-data.frame(c("cCC","cCF", "cCW"), c(0.4015, -0.00993, 0.01828), c( -0.00993, 0.12067,0.00050), c(0.01828,0.00050,0.00311))
colnames(x) <- c(" ","cCC","cCF", "cCW")

r<-data.frame(c(0.35845, 0.13154, 0.02907), c( 0.35845, 0.23651,0.02463), c(0.02907,0.23651,0.00904))
colnames(z) <- c("cCC","cCF", "cCW")

p<-data.frame(c(0.79947, 0.14951, 0.05394), c( 0.14951, 0.39365,0.02979), c(0.05394,0.02979,0.06395), c(0.50221, 0.30654, 0.22078))
colnames(y) <- c("cCC","cCF", "cCW", "heritability")

cvc<-cbind(g,r,p)
kable(x, digits=3, booktabs=T, caption="Genetic and phenotypic variances-covariances for calves (c) derived from Kunz (2018)") %>%
kable_styling(latex_options=c("hold_position")) %>%
 add_header_above(c("","genetic"=3,"residual"=3, "phenotypic"=3,"")) %>%
  column_spec(c(1,4,7,10), border_right = T)

```
---
nocite: | 
  @Kunz2018
...

```{r stirksvariancecomponents, echo=FALSE}
library(knitr)
library(kableExtra)
sg<-data.frame(name=c("sCC","sCF", "sCW"),sCC= c(0.4013, -0.00655, 0.03387), sCF=c( -0.00655, 0.13028,0.01322), sCW=c(0.03387,0.01322,0.01947))
colnames(x) <- c(" ","sCC","sCF", "sCW")

sr<-data.frame(sCC=c(0.26631, 0.00931, 0.04903),sCF= c( 0.00931, 0.19451,0.02162),sCW= c( 0.04903,0.02162,0.03466))
colnames(z) <- c("sCC","sCF", "sCW")

sp<-data.frame(sCC=c(0.71754, 0.07159, 0.09911), sCF=c(0.07159, 0.36439,0.04989), sCW=c(0.09911,0.04989,0.06395), heritability=c(0.55928, 0.35752, 0.30447))
colnames(y) <- c("sCC","sCF", "sCW", "heritability")
svc<-cbind(g,r,p)
kable(svc, digits=3, booktabs=T, caption="Genetic, phenotypic and residual variances-covariances for stirks (s) derived from Kunz (2018)") %>%
kable_styling(latex_options=c("hold_position")) %>%
 add_header_above(c("","genetic"=3,"residual"=3, "phenotypic"=3,""))

```
```{r GeneticGainUniv, echo=FALSE, eval=FALSE}
#intensity of selection (i) computed by proportian selected (p)
p <- 0.2
i <- dnorm(qnorm(1-p))/p
#factor of variance reduction (k)
k <- i * (i - qnorm(p))
#generation intervall (L) in years
L <- 5
#number of progeny (pr) of the selection candidate
pr<-10
#relationshipmatrix (A) of the selection candidate
suppressPackageStartupMessages( library(pedigreemm))
numb <- pr+1
ped <- pedigree(sire = c(NA,1,1,1,1,1,1,1,1,1,1), dam = c(NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA), label = 1:numb)
A <- getA(ped)
Ainv <- as.matrix(getAInv(ped))
#genetic variance (g) of the trait
g<-sg$sCW[3]
#phenotypic variance (ph) of the trait
ph<-sp$sCW[3]
#residual variance (r) of the trait
r<-sr$sCW[3]
#design matrix (Z) connecting the records of observations with the breeding values
Z<-cbind(matrix(0, nrow=pr,ncol=1),diag(pr))
#variance-relationship matrix (R) of the residuals for the recorded animals
R<- r%x%diag(pr)
#prediction error variance (PEV)
PEV <- solve(t(Z)%*%solve(R)%*%Z+Ainv*(1/g))[1,1]
#covariance (C) between true and estimated breeding value
C <-g-PEV
#asymptotic covariance (Ca) between true and estimated breeding value
Ca <- C/(1+0.5*k)
CCa
FCa
WCa
# asymptotic variance of the breeding value (ga)
ga <- sqrt(g-k*Ca)
#asymptotic accuracy of the estimated breeding value (ra) of the selection candidate
ra <- sqrt(Ca/ga^2)
#genetic gain of a breeding value (Q)
Q<- i*ra*ga/L

#correlated genetic gain.
CQ<-i*sqrt(sp$heritability[1])*sqrt(sp$heritability[2])*sqrt(sp$sCC[1])*
WQ

```

The estimated variance components have been used to predict the genetic gain (Q) for the breeding value carcass fat, carcass conformation and carcass weight in "calves" and "stirks".

### Genetic gain (Q)

The value of genetic gain predicts the traits improvement in a population over a period of time, on which the selection occurs.
Therefore it is a useful tool to evaluate the effectiveness of the breeding value carcass fat in improving the desired trait early maturity.

#### Genetic gain equation derivation

The response to selection is highly dependent on the breeding conditions in a population.
The response to selection achieved in one generation is the product of the intensity of selection ($i$), the square root of the accuracy of the breeding value ($r$) and the genetic variance ($\sigma_{g}$).
\begin{equation}
\label{Qgeneration}
Q = ir\sigma_{g}
\end{equation}
$$Q = ir\sigma_{g}$$
The intensity of selection describes, how big the proportion of animals chosen to be parents compared to the whole population is.
For example the intensity of selection is higher when you choose two of 10 animals to be parents than if you choose 5 animals to be parents.
The accuracy of the breeding value tells, how big chances are that the best animals are chosen as parents. 
For example if you have no means to distinguish between the best parents because you do not have any information about them (no records of them or relatives) or you know that the characteristics of the parents will not be inherited to their progeny (heritability=0) it would be completeley random if you choose the best parents.
The additive genetic variance in the population limits the potential for improvement using selection.
For example if you have cows that have the additive genetic potential of daily milk yields in kg of 1, 5, 7, 20 respecteveley you have the potential to get a mean additive genetic potential in milk yield of almost 20 kg by selecting the best animals for parents. 
If you have cows with an additive genetic potential in daily milk yields of 2, 3, 5, 6 respectiveley you will reach not more than an additive genetic potential of 6 kg even if your intensity and accuracy of selection is very high.
The intensity of selection is a value usually based on the usual percentage of animals chosen as parents. In this value the assumption of normal distribution for all traits is assumed (Here formula).

In \autoref{Qgeneration} I computed the response to selection per generation.
However sometimes it occurs that different generations overlap.
Therefore it is usually more suitable to compute the response to selection per year.
To do so \autoref{Qgeneration} extends with the term mean generation interval ($L$) in years.

\begin{equation}
\label{Qyear}
Q = \frac {ir\sigma_{g}}{L}
\end{equation}
$$Q = \frac {ir\sigma_{g}}{L}$$

For example usually selection on beef sires occurs when about 6 years old.
$L$ Would then be 7 y in this case to get the response to selection per year.
In \autoref{Qyear} we make the assumption that we know the mean generation intervall, the intensity of selection and the accuracy of the breeding value for all selection paths.
Or we know that there is no difference in these parameter in different selection paths.
A selection path is defined as a possibility to select on a population.
Different selection paths differ in the type of population on which selection occurs and on the type of selected animals.
Usually we organize selection paths in four categories: Dam - dam, dam - sire, sire - dam, sire - sire. 
There the first term indicates the type of population on which selection occurs and the second term indicates the type of the selected animals.
In case you know only the parameters of each selection path you can transform the formula \autoref{Qyear} to
\begin{equation}
\label{Qselectionpath}
Q = \frac {ir\sigma_{g}}{L}
\end{equation}
$$Q = \frac {\sum_{y=1}^{s} i_yr_y\sigma_g}{\sum_{y=1}^{s}L_y}$$
where $y$ is a selection path and $s$ is the number of selection paths you choose to include in \autoref{Qselectionpath}.
Some years ago @Bulmer1971 discovered that selection on a population reduces the genetic variance of the population over time to an asymptotic value.
Considering the so called "Bulmer Effect" you should use the asymptotic genetic variance and the asymptotic accuracy of breeding values when computing the response to selection.
\begin{equation}
\label{Qasymptotic}
Q^* = \frac {\sum_{y=1}^{2} i_yr_y^*\sigma^*}{\sum_{y=1}^{2}L_y}
\end{equation}
$$Q^* = \frac {\sum_{y=1}^{s} i_yr_y^*\sigma_g^*}{\sum_{y=1}^{s}L_y}$$
In a population already selected for a long time you may probably disregard the Bulmer effect.
I would for sure facilitaty the computation of response to selection.
For example, when you have the accuracy for a breeding value provided by the breeding value estimation, you can just insert its value in the \autoref{Qasymptotic}.
Another approach to compute the accuracies of breeding values is to use the selection index theory developed by @Hazel1943.
There you have to mimic breeding value estimation using linear regression of breeding values on phenotypes.
Then you need to find the regression coefficients and compute the accuracy of a breeding value.
An index in this context is a synonym for estimated breeding value.
You can compute the index by summing phenotypic records $x$ on a selection candidate and weigh them with $b$ according to their significance for the breeding value.
\begin{equation}
\label{selectionindex}
Â=\sum_{x=1}^{q}b_x*x_x
\end{equation}
$$Â=\sum_{z=1}^{q}b_zx_z$$
For example you would like to compute the breeding value or index of cattle sire.
You have available the phenotypic observation of a full sib and a half sib in which is known as difference to the population mean.
You should now choose $b$ for the half sib to be equal or less than 0.25 and for the full sib equal or less than 0.5. 
$b$ can further decrease when heratibility is low.
The accuracy of selection $r$ is the correlation between the true breeding value and the estimated breeding value.
For selection index theory it is 
\begin{equation}
\label{accuracyselectionindex}
r= \frac { \sqrt{b'G}}{\sigma_g}
\end{equation}
$$r= \frac { \sqrt{b'G}}{\sigma_g} $$
Using this approach including the "Bulmer effect" I was able to compute the genetic gains for the carcass traits dependent on their economical value.


Therefore we created likely scenarios simulating breeding conditions for male and female selection candidates to assess the effect of breeding conditions on response to selection for this case.

The chosen scenarios differ in the number and relationship of relatives the selection candidates have and the proportion of selected male/female animals that will be parents of the beef cattle population in a generation.
From the proportion of selected animals we have computed intensities of selection applied on the population assuming that carcass fat, carcass conformation and carcass weight are normally distributed in the examined beef cattle population.
We used the R command 
Then we assigned economical weights as additional revenue in Sfr. / unit of trait gain for the involved traits carcass fat, carcass conformation and carcass weight.
The values for the scenarios are available at ... Here I will create a table combining the assumed values for each scenarion (number of siblings, number of half siblings, proportion selected, intensity of selection, economical weights)

For each scenario we have predicted the specific traits improvement $Q_m^*$ from the aggregate genotype asymptotic response to selection using linear regression as shown in \autoref{Qm} [@Andersen1994].
All computations have been conducted using RStudio [@RStudio2016].

\begin{equation}
\label{Qm}
Q_m^*= \frac {\sum_{y=1}^{2} i_ya^T(C_y^*)_m \sqrt{a^TC_y^*a}}{\sum_{y=1}^{2}L_y}
\end{equation}

Where:

* $Q$ = response to selection [trait unit / years]

* $_m$ = trait: carcass fat, carcass conformation or carcass weight. Here it means that we only take $m$ part of the matrix $C$ which makes it a $q x q$ dimensional matrix.

* $^*$ = indicates that reduction of variance during selection has been taken into account known as "Bulmer effect", values turn to asymptotic values [@Bulmer1971].

* $_y$ = sex of the predicted selection candidate (1 = male, 2 = female)

* $i$ = intensity of selection

* $C$ = covariance matrix between true and estimated breeding value before selection of dimesion $qn x qn$ ; $n$ = number of traits, $q$ = number of levels for random effects

* $a$ = vector of economical weights [Sfr. / trait unit]

* $L$ = generation intervall [years]


We have computed the response to selection $Q^*$ of the aggregate genotype  based on the following formula derived from [@Phocas1996]:

\begin{equation}
\label{Qagr}
Q^* = \frac {\sum_{y=1}^{2} i_yr_y^*\sigma^*}{\sum_{y=1}^{2}L_y}
\end{equation}

Where:

* $r$ = accuracy of aggregate genotype

* $\sigma$ = standard deviation of aggregate genotype

We computed $r^*_y$ and $\sigma^*$ using the following formulas:

\begin{equation}
\label{rasympt}
r^*=\sqrt{\frac {a^TC_y^*a}{a^TG^*a}}
\end{equation}

and

\begin{equation}
\label{sigasympt}
\sigma^*=\sqrt{a^TG^*a}
\end{equation}

Where

* $G$ = genetic variance-covariance matrix

To get $C_y^*$ we used the formula:

\begin{equation}
\label{Casympt}
\begin{bmatrix}
C_1^* \\
C_2^*
\end{bmatrix}
=
\left( 
\begin{bmatrix}
1+1/2k_1  &  1/2k_2 \\
1/2k_1    &  1+1/2k_2
\end{bmatrix}^{-1}
\otimes I_n
\right)
\begin{bmatrix}
C_1 \\
C_2
\end{bmatrix}
\end{equation}

Where

* $k$ = factor of variance reduction

* $n$ = number of traits involved

* $I$ = identity matrix of dimension n


We computed $k$ using the formula:

\begin{equation}
\label{kvarred}
k_y=i_y(i_y-x_y)
\end{equation}


Where 

* $x$ = value of trunctation on the x-axis of the populations normal distribution [standard deviations]

We computed $x_y$ from the proportion selected using the R-command `qnorm(proportion_selected, lower.tail = FALSE)`

To get the covariance matrix between true and estimated breeding value before selection $C_y$ we used the following formula:

\begin{equation}
\label{kvarred}
C_y=A_y \otimes G-PEV_y
\end{equation}

Where

* $A$ = numerator relationship matrix of dimension q x q; q = number of levels for random effects.

* $\otimes$ = sign for kronecker product

* $PEV$ = prediction error variance




#### Response to selection based on Pimentel

In contrast to the approach of Phocas and Vonrohr, Pimentel does not assume a probable breeding scenario using records from relatives.
Pimentel's approach is based on the selection index theory developed by @Hazel1943.
The selection index theory describes how an aggregate genotype can be computed.
The term genotype is here used as synonym for breeding value.




\begin{equation}
Q_m^*= \frac { \sum_{y=1}^{2} i_ya^T(C_y^*)_m \sqrt{a^TC_y^*a}}{\sum_{y=1}^{2}L_y}
(\#eq:Qm)
\end{equation}

Watch \@ref(eq:Qm)

\begin{equation}
\label{Qm}
Q_m^*= \frac { \sum_{y=1}^{2} i_ya^T(C_y^*)_m \sqrt{a^TC_y^*a}}{\sum_{y=1}^{2}L_y}
\end{equation}

see \autoref{Qm}

@Phocas1996



