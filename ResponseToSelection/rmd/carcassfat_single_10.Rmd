---
title: "carcassfat_single_cv"
author: "Silvan"
date: "24 9 2018"
output: pdf_document
bibliography: /Users/silvan/Documents/EarlyMaturityBeef/embc-thesis-bd/library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r SelIntensity}
#intensity of selection (i) computed by proportian selected (p)
p <- 0.2
(i <- dnorm(qnorm(1-p))/p)
```

The next step is to compute the variance reduction factor $k$

```{r VarReductionFactor}
#factor of variance reduction (k)
(k <- i * (i - qnorm(p)))
```

The generation intervall is empirically approximated (rule of thumb).

```{r GenerationIntervall}
#generation intervall (L) in years
L <- 2
```

Then I can compute the relationship matrix of the selection candidate.
The relationship matrix is defined by the number and type of records I have at the moment of selection.
Here I assume to have 10 records of progeny from the selection candidate.

```{r RelMat}
#number of progeny (pr) of the selection candidate
pr<-10
#relationshipmatrix (A) of the selection candidate
suppressPackageStartupMessages( library(pedigreemm))
numb <- pr+1
ped <- pedigree(sire = c(NA,1,1,1,1,1,1,1,1,1,1), dam = c(NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA), label = 1:numb)
A <- getA(ped)
Ainv <- as.matrix(getAInv(ped))
Ainv
```

I know the variance components from the estimation of variance components of @Kunz2018.

```{r VarComp}
#genetic variance (g) of the trait
g<-0.12067
#phenotypic variance (ph) of the trait
ph<-0.39365
#residual variance (r) of the trait
r<-0.23651
```

Then I compute the design matrix Z from the knowledge of available records and number of animals with breeding values.

```{r DesignMat}
#design matrix (Z) connecting the records of observations with the breeding values
Z<-cbind(matrix(0, nrow=pr,ncol=2),diag(pr))
Z
```


__Comment PvR__: The number of columns in Z must be the same as the number of rows in A. This is not the case here, see code junks below. That is also the reason why the computation of PEV does not work.

```{r}
cat("Number of columns in Z: ", ncol(Z), "\n")
cat("Number of rows in A:    ", nrow(A), "\n")
```


Then I compute the variance matrix of residuals by the knowledge of residual variance in the population and the number of records.

```{r VarMatRes}
#variance-relationship matrix (R) of the residuals for the recorded animals
R<- r%x%diag(pr)
R
```

The prediction of variance is the next variable I need to compute.
To compute it I use Z, R, A and g.
After computing the matrix I cut out the part which belongs to the selection candidate (either animal number 1 or 2 in the relationship matrix).
This is then called the prediction error variance of the selection candidate.

```{r PredErrorVar}
#prediction error variance (PEV)
PEV <- solve(t(Z)%*%solve(R)%*%Z+Ainv*(1/g))[1,1]
PEV
```

From the prediction error variance I can compute the covariance between true and estimated breeding value of the selection candidate.

```{r CovTrueEstBV}
#covariance (C) between true and estimated breeding value
C <-g-PEV
C
```

Then I compute the asymptotic pendant incorporating the factor of variance reduction. 

```{r AsymptCovTrueEstBV}
#asymptotic covariance (Ca) between true and estimated breeding value
Ca <- C/(1+0.5*k)
Ca
```

I compute the asymptotic variance of the breeding value from the asymptotic covariance.

```{r AsymptVarBV}
# asymptotic variance of the breeding value (ga)
ga <- g-k*Ca
ga
```


The asymptotic accuracy of the breeding value is defined by Ca and ga.

```{r AsymptAccuracy}
#asymptotic accuracy of the estimated breeding value (ra) of the selection candidate
ra <- sqrt(Ca/ga)
ra
```

Then I can compute the genetic gain.

```{r GeneticGain}

#genetic gain of a breeding value (Q)
Q<- i*ra*sqrt(ga)/L
Q
```



# References


