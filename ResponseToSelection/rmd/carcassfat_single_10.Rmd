---
title: "carcassfat_single_cv"
author: "Silvan"
date: "24 9 2018"
output: pdf_document
bibliography: /Users/silvan/Documents/EarlyMaturityBeef/embc-thesis-bd/library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
aim: Compute genetic gain for carcass fat (CF) in an univariate case.

# Response to selection

The genetic gain of a breeding value is possible to compute from: 

$$Q = \frac {ir^*\sigma^*}{L}$$
We start by computing the selection intensity $i$ for a given proportion $p$

```{r SelectionIntensity}
#intensity of selection (i) computed by proportian selected (p)
p <- 0.2
(i <- dnorm(qnorm(1-p))/p)
```

The next step is to compute the variance reduction factor $k$

```{r VarianceReductionFactor}
#factor of variance reduction (k)
(k <- i * (i - qnorm(p)))
```

```{r}
#intensity of selection (i) computed by proportian selected (p)
p <- 0.2
i <- dnorm(qnorm(1-p))/p
#factor of variance reduction (k)
k <- i * (i - qnorm(p))
#generation intervall (L) in years
L <- 2
#number of progeny (pr) of the selection candidate
pr<-10
#relationshipmatrix (A) of the selection candidate
suppressPackageStartupMessages( library(pedigreemm))
numb <- pr+2
ped <- pedigree(sire = c(NA,NA,1,1,1,1,1,1,1,1,1,1), dam = c(NA,NA,2,2,2,2,2,2,2,2,2,2), label = 1:numb)
A <- getA(ped)
Ainv <- as.matrix(getAInv(ped))

#genetic variance (g) of the trait
g<-0.3
#phenotypic variance (p) of the trait
p<-0.4
#residual variance (r) of the trait
r<-p-g
#design matrix (Z) connecting the records of observations with the breeding values
Z<-cbind(matrix(0, nrow=pr,ncol=2),diag(pr))
#variance-relationship matrix (R) of the residuals for the recorded animals
R<-Z%*%(A%x%p)%*%t(Z)-Z%*%(A%x%g)%*%t(Z)
#prediction error variance (PEV)
PEV <- solve(t(Z)%*%solve(R)%*%Z+solve(A)%x%(1/g))[1,1]
# no kronecker %x% for scalar multiplication
PEV <- solve(t(Z)%*%solve(R)%*%Z+solve(A)*(1/g))[1,1]

#covariance matrix (C) between true and estimated breeding values
C <-g-PEV
#asymptotic covariance matrix (Ca) between true and estimated breeding values
Ca <- C/(1+0.5*k)
#variance of the breeding value (ga)
ga <- g-k*Ca
#asymptotic accuracy of the estimated aggregate genotype (ra) of the selection candidate
ra <- sqrt(Ca/ga)
#genetic gain of a breeding value (Q)
Q<- i*ra*sqrt(ga)/L
```

$i$ is the selection intensity and is available.

$L$ is the generation intervall in years and is available.

$r^*$ is the accuracy of the estimated aggregate genotype of the selection candidate.

$\sigma^*$ is the standard deviation of the breeding value.

$^*$ = indicates that reduction of variance during selection has been taken into account known as "Bulmer effect", values turn to asymptotic values [@Bulmer1971].

The variable $r^*$ has to be computed first with
$$r^*=\sqrt{\frac {C^*}{ \sigma_g^2}}$$

$C_y^*$ is the asymptotic covariance between true and estimated breeding values of the selection candidate before the selection

$\sigma^*$ has to be computed with
$$(\sigma^*)^2=\sigma_g^2-kC^*$$

$k$ = factor of variance reduction is available.

$\sigma_g$ is the genetic standard deviation in the population and is available.

However to solve these equations you need to first calculate the $C^*$ by the formula:
$$C^*=\frac{C}{1+0.5k} $$

$C$ is defined by
$$C=\sigma_g^2-PEV$$

$PEV$ is the prediction error variance

I can compute $PEV$ with the formula derived from [@Phocas1996]. I take only the part of the PEV-matrix that belongs to the selection candidate, which is one element of the matrix.
$$
PEV=(Z^TR^{-1}Z+A^{-1} \otimes (\sigma_g^2)^{-1})^{-1}
$$

$A$ is relationship matrix and available

$\otimes$ is a kronecker product

$Z$ is a design matrix that connects the records of observations (does not include the breeding candidate and its parents) with the breeding values (includes the candidate and its parents) and is available.

$R$ is the variance-relationship matrix of the residuals for the traits and the recorded animals.

I can compute $R_y$ with the following formula.
$$R=Z(A\otimes \sigma_p^2)Z^T-Z(A\otimes \sigma_g^2)Z^T$$

$\sigma_p$ is the phenotypic variance and available.


# References


