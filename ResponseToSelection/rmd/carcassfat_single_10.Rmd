---
title: "carcassfat_single_cv"
author: "Silvan"
date: "24 9 2018"
output: pdf_document
bibliography: /Users/silvan/Documents/EarlyMaturityBeef/embc-thesis-bd/library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
aim: Compute genetic gain for carcass fat (CF) in an univariate case.

# Response to selection

I compute the genetic gain of a breeding value using the formula derived from @Phocas1998: 

$$Q = \frac {ir^*\sigma^*}{L}$$

$i$ is the selection intensity

$L$ is the generation intervall in years

$r^*$ is the accuracy of the of the breeding value of the selection candidate

$\sigma^*$ is the standard deviation of the breeding value.

$^*$ = indicates that reduction of variance during selection has been taken into account known as "Bulmer effect", value turns to asymptotic value [@Bulmer1971].

### Selection intensity

I compute the selection intensity from the assumed proportion of selected animals.
The proportion of selected animals is the share of animals born that will be parents of the next generation. 


The variable $r^*$ has to be computed first with
$$r^*=\sqrt{\frac {C^*}{ \sigma_g^2}}$$

$C_y^*$ is the asymptotic covariance between true and estimated breeding values of the selection candidate before the selection

$\sigma^*$ has to be computed with
$$(\sigma^*)^2=\sigma_g^2-kC^*$$

$k$ = factor of variance reduction is available.

$\sigma_g$ is the genetic standard deviation in the population and is available.

However to solve these equations you need to first calculate the $C^*$ by the formula:
$$C^*=\frac{C}{1+0.5k} $$

$C$ is defined by
$$C=\sigma_g^2-PEV$$

$PEV$ is the prediction error variance

I can compute $PEV$ with the formula derived from [@Phocas1996]. I take only the part of the PEV-matrix that belongs to the selection candidate, which is one element of the matrix.
$$
PEV=(Z^TR^{-1}Z+A^{-1} \otimes (\sigma_g^2)^{-1})^{-1}
$$

$A$ is the relationship matrix of the selection candidate and is available

$\otimes$ is a kronecker product

$Z$ is a design matrix that connects the records of observations (does not include the breeding candidate and its parents) with the breeding values (includes the candidate and its parents) and is available.

$R$ is the variance-relationship matrix of the residuals for the traits and the recorded animals.

I can compute $R_y$ with the following formula.
$$R=Z(A\otimes \sigma_p^2)Z^T-Z(A\otimes \sigma_g^2)Z^T$$

$\sigma_p$ is the phenotypic variance and available.


I start by computing the selection intensity $i$ for a given proportion $p$

```{r SelIntensity}
#intensity of selection (i) computed by proportian selected (p)
p <- 0.2
(i <- dnorm(qnorm(1-p))/p)
```

The next step is to compute the variance reduction factor $k$

```{r VarReductionFactor}
#factor of variance reduction (k)
(k <- i * (i - qnorm(p)))
```

The generation intervall is empirically approximated (rule of thumb).

```{r GenerationIntervall}
#generation intervall (L) in years
L <- 2
```

Then I can compute the relationship matrix of the selection candidate.
The relationship matrix is defined by the number and type of records I have at the moment of selection.
Here I assume to have 10 records of progeny from the selection candidate.

```{r RelMat}
#number of progeny (pr) of the selection candidate
pr<-10
#relationshipmatrix (A) of the selection candidate
suppressPackageStartupMessages( library(pedigreemm))
numb <- pr+2
ped <- pedigree(sire = c(NA,NA,1,1,1,1,1,1,1,1,1,1), dam = c(NA,NA,2,2,2,2,2,2,2,2,2,2), label = 1:numb)
A <- getA(ped)
Ainv <- as.matrix(getAInv(ped))
Ainv
```

I know the variance components from the estimation of variance components of @Kunz2018.

```{r VarComp}
#genetic variance (g) of the trait
g<-0.12067
#phenotypic variance (ph) of the trait
ph<-0.39365
#residual variance (r) of the trait
r<-0.23651
```

Then I compute the design matrix Z from the knowledge of available records and number of animals with breeding values.

```{r DesignMat}
#design matrix (Z) connecting the records of observations with the breeding values
Z<-cbind(matrix(0, nrow=pr,ncol=2),diag(pr))
Z
```

Then I compute the variance matrix of residuals by the knowledge of residual variance in the population and the number of records.

```{r VarMatRes}
#variance-relationship matrix (R) of the residuals for the recorded animals
R<- r%x%diag(pr)
R
```

The prediction of variance is the next variable I need to compute.
To compute it I use Z, R, A and g.
After computing the matrix I cut out the part which belongs to the selection candidate (either animal number 1 or 2 in the relationship matrix).
This is then called the prediction error variance of the selection candidate.

```{r PredErrorVar}
#prediction error variance (PEV)
PEV <- solve(t(Z)%*%solve(R)%*%Z+Ainv*(1/g))[1,1]
PEV
```

From the prediction error variance I can compute the covariance between true and estimated breeding value of the selection candidate.

```{r CovTrueEstBV}
#covariance (C) between true and estimated breeding value
C <-g-PEV
C
```

Then I compute the asymptotic pendant incorporating the factor of variance reduction. 

```{r AsymptCovTrueEstBV}
#asymptotic covariance (Ca) between true and estimated breeding value
Ca <- C/(1+0.5*k)
Ca
```

I compute the asymptotic variance of the breeding value from the asymptotic covariance.

```{r AsymptVarBV}
# asymptotic variance of the breeding value (ga)
ga <- g-k*Ca
ga
```


The asymptotic accuracy of the breeding value is defined by Ca and ga.

```{r AsymptAccuracy}
#asymptotic accuracy of the estimated breeding value (ra) of the selection candidate
ra <- sqrt(Ca/ga)
ra
```

Then I can compute the genetic gain.

```{r GeneticGain}

#genetic gain of a breeding value (Q)
Q<- i*ra*sqrt(ga)/L
Q
```



# References


