---
title: "ResponseToSelection_CarcassTraits_Multivariate"
author: "Silvan"
date: "18 10 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning = FALSE)
```

# Goal

To compute genetic gains of the traits carcass fatt, carcass conformation and carcass weight. Each trait for adults and calves. (6 traits in total).

# Plan

Firstly, to record and name all input parameters either as tables or as variables in separate files.
Secondly, show all necessary equations/descriptions from bottom to top.
Thirdly, create R chunks that read the input parameters and solve the equations.

# Material

* Residual, phenotypic and genetic variances and covariances of and between all traits.
* Breeding scenario (number of records of offspring/itself/half siblings/full siblings per selection candidate). The scenario will result in a pedigree.
* Generation intervall and proportion selected of the population.
* Economic value for each trait.

# Implementation

First I import the input parameters using read.table(). 
Synchronically I adjust the input parameters to get the variables of the following computations.

## Input parameters

### Genetic, Residual and Phenotypic Variances/Covariances

With CC,CF,CW.
```{r VariancesCovariances}
# Set working directory
setwd("~/Documents/EarlyMaturityBeef/ResponseToSelection/rmd")
# import variance covariance dataframes and compute matrix
## genetic
genetic_var_cov <- "adults_calves_genetic_variances_covariances"
genetic_var_cov <- read.table(file = genetic_var_cov, sep=";", header=TRUE)
genetic_var_cov <- as.matrix(genetic_var_cov)
## residual
residual_var_cov <- "adults_calves_residual_variances_covariances"
residual_var_cov <- read.table(file = residual_var_cov, sep=";", header=TRUE)
residual_var_cov <- as.matrix(residual_var_cov)
## phenotypic
phenotypic_var_cov <- "adults_calves_phenotypic_variances_covariances"
phenotypic_var_cov <- read.table(file = phenotypic_var_cov, sep=";", header=TRUE)
phenotypic_var_cov <- as.matrix(phenotypic_var_cov)
```

### Number of Relatives

First the number of relatives is imported.
```{r NumberofRelatives}
library(dplyr)
# Set working directory
setwd("~/Documents/EarlyMaturityBeef/ResponseToSelection/rmd")
# number of fullsiblings, half siblings and offspring
## fullsiblings
fullsiblings <- "number_of_relatives"
fullsiblings <- read.table(file = fullsiblings, sep=";", header=TRUE) %>%
  select(fullsiblings)
fullsiblings <- as.numeric(fullsiblings)
fullsiblings
## half siblings
halfsiblings <- "number_of_relatives"
halfsiblings <- read.table(file = halfsiblings, sep=";", header=TRUE) %>%
  select(halfsiblings)
halfsiblings <- as.numeric(halfsiblings)
halfsiblings
## offspring
offspring <- "number_of_relatives"
offspring <- read.table(file = offspring, sep=";", header=TRUE) %>%
  select(offspring)
offspring <- as.numeric(offspring)
offspring
```


### Generation intervall and proportion selected

```{r GenerationIntervall}
library(dplyr)
# Set working directory
setwd("~/Documents/EarlyMaturityBeef/ResponseToSelection/rmd")
generationintervall <- "proportion_selected_generation_intervall"
generationintervall <- read.table(file = generationintervall, sep=";", header=TRUE) %>%
  select(generationintervall)
generationintervall <- as.numeric(generationintervall)
generationintervall
```

```{r ProportionSelected}
library(dplyr)
# Set working directory
setwd("~/Documents/EarlyMaturityBeef/ResponseToSelection/rmd")
proportionselected <- "proportion_selected_generation_intervall"
proportionselected <- read.table(file = proportionselected, sep=";", header=TRUE) %>%
  select(proportionselected)
proportionselected <- as.numeric(proportionselected)
proportionselected
```

### Economic values a

```{r}
library(dplyr)
# Set working directory
setwd("~/Documents/EarlyMaturityBeef/ResponseToSelection/rmd")
# always calves first and CC,CF,CW
a <- "economic_values_breeding_for_aCF"
a <- read.table(file = a, sep=";", header=TRUE)
a <- as.numeric(a)
a
```

## Computations without equations

### Number of traits n

```{r}
n <- as.numeric(nrow(phenotypic_var_cov))
```

### Variance Covariance Matrices G (genetic) and R (residual)

```{r}
G <- genetic_var_cov
R <- residual_var_cov %x% diag(offspring)
```


### Relationship Matrix RM and Inverse RM

```{r RelationshipMatrix}
# Compute the relationsship matrix dependent on the number of offspring of the selection candidate. The selection candidate is the first animal.
suppressPackageStartupMessages(library(pedigreemm))
mnumb <- offspring+1
A <- pedigree(sire = c(NA,rep(1,times = offspring)), dam =c(NA,rep(NA,times = offspring)), label = 1:mnumb)
# Compute inverse of relationsship matrix.
Ainv <- getAInv(A)
```

### Design matrix Z

```{r DesignMatrix}
Z<-cbind(matrix(0, nrow=offspring*n,ncol=n),diag(offspring*n))
dim(Z)
```


### Selection intensity (i) and value of trunctation (x)

```{r}
i <- dnorm(qnorm(1-proportionselected))/proportionselected
x <- qnorm(proportionselected, lower.tail = FALSE)
```

## Computations with Equations

### Factor of variance reduction $k$

$$k=i(i-x)$$

```{r}
k <- i*(i-x)
```


### Prediction error variance PEV

$$PEV_{mat}=\sqrt{Z^TR^{-1}Z+A^{-1} \otimes G^{-1}}$$

```{r PEVmat}
# Proove that G and R are positive definite
#eigen(G)
#eigen(R)
# Produce PEV matrix
PEVmat <- solve(t(Z)%*%solve(R)%*%Z+Ainv%x%solve(G))
```

$$PEV=PEV_{mat}[1:n,1:n]$$

```{r PEV}
PEV <- PEVmat[1:n,1:n]
PEV
```

### Covariance matrix between true and estimated breeding values $C$

$$C=G-PEV $$

```{r CovarianceMatrix}
C <- G-PEV
```

### Asymptotic covariance matrix $C^*$ between true and estimated breeding values

$$C^*=\frac{C}{1+0.5*k} $$

```{r AsymptoticCovarianceMatrix}
Ca <- C/(1+0.5*k)
```

### Asymptotic genetic variance/covariance matrix $G^*$

$$G^*=G-1/2(k(a^TC^*a)^{-1}C^*aa^TC^*)$$

```{r AsymptoticGeneticMatrix}
Ga<-k*1/sqrt(as.numeric(t(a)%*%Ca%*%a))*Ca%*%a%*%t(a)%*%Ca
```

### Accuracy of the estimated overall breeding value $r^*$

$$r^*=\sqrt{\frac {a^TC^*a}{a^TG^*a}}$$

```{r AccuracyOverall}
ra <- sqrt(as.numeric((t(a)%*%Ca%*%a)/as.numeric(t(a)%*%Ga%*%a)))
dim(Ca)
dim(Ga)
ra
```

### Standard deviation of the estimated overall breeding value $\sigma^*$

$$\sigma^*=\sqrt{a^TG^*a}$$

```{r StandardDeviationOverall}
StdevOverall<-sqrt(as.numeric(t(a)%*%Ga%*%a))
StdevOverall
```

### Asymptotic genetic gain of the estimated overall breeding value

$$Q= \frac {ir^*\sigma^*}{L}$$

```{r GeneticGainOverall}
Qoverall <- i*ra*StdevOverall/generationintervall
Qoverall
```

### Asymptotic genetic gain of a trait (here carcass fat)

$$Q_m^*= \frac { ia^T(C^*)_m \sqrt{a^TC^*a}}{L}$$

```{r GeneticGainTrait}
Qtrait<- i*as.numeric(t(a)%*%Ca[,"aCF"])*sqrt(as.numeric(t(a)%*%Ca%*%a))/generationintervall
Qtrait
```





